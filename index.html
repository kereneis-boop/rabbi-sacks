<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mind‑Map • Standalone (Embed‑ready) — ZoomFit v2</title>
<link href="https://fonts.googleapis.com/css2?family=Alef:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7f8fc; --ink:#0f172a;
    --chip-h:44px; --col-step:340px; --gap-x:28px; --gap-y:12px;
    --r:9999px; --shadow:0 8px 22px rgba(0,0,0,.10);
    --edge:#C5CBD8; --toggle:#fe0100;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:'Alef', system-ui, -apple-system, "Segoe UI", Arial, sans-serif}
  .wrap{padding:16px; height:100dvh; overflow:auto; max-width:1400px; margin:0 auto}
  .viewport{position:relative; height:100%;}
  .stage{position:relative; min-height:380px; min-width:560px; transform-origin: top right; transition: transform .28s cubic-bezier(.22,1,.36,1); opacity:0}
  .chips{position:absolute; inset:0; z-index:1}
  svg{position:absolute; inset:0; width:100%; height:100%; overflow:visible; z-index:0}

  /* Zoom controls */
  .zoombar{position:absolute; top:12px; inset-inline-start:12px; display:flex; gap:8px; z-index:3}
  .zoombar button{border:0; border-radius:10px; padding:8px 10px; font-family:inherit; font-weight:800; cursor:pointer;
                  box-shadow:0 6px 14px rgba(0,0,0,.12); background:#fff}
  .zoombar .pct{min-width:68px; text-align:center}

  /* Capsules */
  .chip{position:absolute; display:inline-flex; align-items:center; height:var(--chip-h); padding:0 16px; border-radius:var(--r);
        line-height:1; white-space:nowrap; box-shadow:var(--shadow),inset 0 1px 0 rgba(255,255,255,.6);
        direction: rtl; text-align:right; font-weight:700; gap:10px;
        transition:left .32s cubic-bezier(.22,1,.36,1), top .32s cubic-bezier(.22,1,.36,1), opacity .22s ease;
        flex-direction: row-reverse; justify-content:flex-start; background: var(--chip-bg, #ffffff); color:#0f172a;}
  .chip[data-kind="root"]{font-weight:800}
  .label{pointer-events:none}
  .toggle{width:24px;height:24px;border-radius:50%;display:grid;place-items:center;flex:0 0 auto;background:var(--toggle); color:#fff; cursor:pointer}
  .toggle::before{content:"+"; font-weight:900; font-size:14px; line-height:1}
  .chip[aria-expanded="true"] .toggle::before{content:"-"}
  .edge{fill:none; stroke:var(--edge); stroke-width:2; transition:opacity .2s ease}
  .appear{animation: chipIn .22s cubic-bezier(.22,1,.36,1) both}
  @keyframes chipIn{ from{opacity:.001; transform:translateY(-3px)} to{opacity:1; transform:translateY(0)} }

  @media (prefers-reduced-motion: reduce){
    .stage{transition:none}
    .chip{transition:none}
    .edge{transition:none}
    .appear{animation:none}
  }

  @media (max-width:900px){:root{--chip-h:40px; --col-step:300px}}
</style>
</head>
<body>
<div class="wrap">
  <div id="viewport" class="viewport">
    <div class="zoombar" aria-label="Zoom controls">
      <button id="fitW" title="התאם לרוחב">↔︎ התאמה</button>
      <button id="zoomOut" title="Zoom out">−</button>
      <button id="zoomPct" class="pct" title="100%">100%</button>
      <button id="zoomIn" title="Zoom in">+</button>
    </div>
    <div id="app" class="stage">
      <svg id="edges" aria-hidden="true"></svg>
      <div id="chips" class="chips"></div>
    </div>
  </div>
</div>

<!-- === DATA: ערכי כאן או החליפי JSON מבחוץ === -->
<script id="mindmap-data" type="application/json">
{
  "dir": "rtl",
  "flow": "rtl",
  "root": {
    "label": "הרב יונתן זקס: חיים והגות",
    "children": [
      {"label":"חיים וביוגרפיה","children":[
        {"label":"פתח דבר","children":[{"label":"הוגה בולט"},{"label":"הרב הראשי של בריטניה (22 שנה)"},{"label":"מנהיג רוחני ואינטלקטואל ציבורי"},{"label":"מחבר ~30 ספרים (רבי־מכר)"},{"label":"מרצה ברחבי העולם"}]},
        {"label":"חיים מוקדמים והשכלה","children":[{"label":"נולד 1948, לונדון"},{"label":"משפחה יהודית מסורתית"},{"label":"סביבה חמה ותומכת"},{"label":"חשיפה למחשבה מוסרית/רוחנית"},{"label":"תנועות נוער יהודיות"},{"label":"לימודים: פילוסופיה, אונ׳ קמברידג׳"},{"label":"זיהה פער: מופשט מול מציאות חברתית"}]},
        {"label":"השפעות מרכזיות ונקודות מפנה","children":[{"label":"פגישות בניו יורק","children":[{"label":"הרבי מלובביץ׳"},{"label":"הרב יוסף דב סולובייצ׳יק"}]},{"label":"אתגר להנהיג ולעשות"},{"label":"השפעה עמוקה על מחשבתו ועל ראיית הקהילה"}]},
        {"label":"קריירה וחזון","children":[{"label":"לימודי פילוסופיה מתקדמים (BA, PhD)"},{"label":"רב בקהילות באנגליה"},{"label":"מונה לרב הראשי של בריטניה"},{"label":"מסר מרכזי: אחדות הקהילות היהודיות"},{"label":"כוח הקהילה: שייכות וזהות"}]},
        {"label":"השפעה רחבה והכרה","children":[{"label":"הציג את היהדות כמקור השראה מוסרי/חברתי"},{"label":"דמות משמעותית לפוליטיקאים, אינטלקטואלים ומלוכה"},{"label":"מפגשים בולטים: המלכה אליזבת, המלך צ׳ארלס, הדלאי למה"}]}]},
      {"label":"רעיונות יסוד ופופולריות","children":[
        {"label":"מורשת אינטלקטואלית והשפעות","children":[{"label":"מחשבה יהודית אורתודוקסית (מנדלסון, הרש\"ר הירש, ר׳ סולובייצ׳יק, הראי\"ה קוק)"},{"label":"השפעות נוספות (הרבי מלובביץ׳, ויקטור פרנקל)"},{"label":"ממשיך מסורת – מותאם למאה ה‑20/21"}]},
        {"label":"מחבר מודרנה ויהדות","children":[{"label":"דיאלוג עם התרבות העכשווית"},{"label":"אמונה ותבונה במרחב הציבורי"}]},
        {"label":"פופולריות וגישת כתיבה","children":[{"label":"שפה בהירה ונגישה"},{"label":"ראיית עולם אופטימית וקול קהילתי"}]},
        {"label":"מחשבה דתית אלטרנטיבית","children":[{"label":"מחויבות בריתית (Covenantal Responsibility)"},{"label":"כבוד השוני (Dignity of Difference)"}]}]}
    ]
  }
}
</script>

<script>
(function(){
  const data = JSON.parse(document.getElementById('mindmap-data').textContent);
  const DIR = (data.dir||'rtl'); document.documentElement.setAttribute('dir', DIR);
  const FLOW = (data.flow||'rtl');
  const viewport = document.getElementById('viewport');
  const stage = document.getElementById('app');
  const chipLayer = document.getElementById('chips');
  const edgeLayer = document.getElementById('edges');
  if(DIR==='ltr'){ stage.style.transformOrigin = 'top left'; }

  const CHIP_H = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--chip-h')) || 44;
  const COL_STEP = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--col-step')) || 340;
  const GAP_X = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap-x')) || 28;
  const GAP_Y = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap-y')) || 12;

  /* Fixed colors by level (incl. root) */
  const DEPTH_COLORS = {0:'#F8E8FF', 1:'#EBDCF8', 2:'#D4D2E6', 3:'#D7F6E4', 4:'#50E38A'};

  function build(raw, depth=0, parent=null){
    const node = { label: raw.label, depth, parent, collapsed: !!raw.collapsed, x:0,y:0,width:0,height:CHIP_H, el:null, id: Math.random().toString(36).slice(2), _subH:0, children: [] };
    (raw.children||[]).forEach(ch=> node.children.push(build(ch, depth+1, node)));
    return node;
  }
  const root = build(data.root, 0, null);

  function ensureChip(node){
    if(node.el) return;
    const el = document.createElement('div'); el.className = 'chip';
    el.dataset.kind = node.depth===0 ? 'root' : (node.children.length? 'cat':'leaf');
    const label = document.createElement('span'); label.className='label'; label.textContent=node.label; el.appendChild(label);
    if(node.children.length){
      const t = document.createElement('span'); t.className='toggle'; el.appendChild(t);
      el.setAttribute('aria-expanded', String(!node.collapsed));
      el.addEventListener('click', ev => { if(ev.target.closest('.toggle')){ toggleNode=node; node.collapsed=!node.collapsed; layout(true);} });
      el.addEventListener('keydown', ev=>{ if(ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); toggleNode=node; node.collapsed=!node.collapsed; layout(true);} });
      el.setAttribute('tabindex','0'); el.setAttribute('role','button');
    }
    const base = DEPTH_COLORS[Math.min(node.depth,4)] || DEPTH_COLORS[4];
    el.style.setProperty('--chip-bg', base);
    chipLayer.appendChild(el); node.el=el;
  }
  (function collect(n){ ensureChip(n); n.children.forEach(collect); })(root);

  function measure(node){
    node.el.style.left = '-10000px'; node.el.style.top = '-10000px';
    node.width = Math.max(140, node.el.offsetWidth);
    node.children.forEach(measure);
  }
  function subHeight(node){
    if(node.collapsed || node.children.length===0){ node._subH = node.height; return node._subH; }
    let total = 0; node.children.forEach((c,i)=>{ subHeight(c); total += c._subH; if(i>0) total += GAP_Y; });
    node._subH = Math.max(node.height, total); return node._subH;
  }
  function position(node, depth, top){
    node.x = depth * (COL_STEP + GAP_X) * (FLOW==='rtl' ? -1 : 1);
    node.y = top + node._subH/2;
    if(!(node.collapsed) && node.children.length){
      let cursor = top;
      node.children.forEach((c)=>{ position(c, depth+1, cursor); cursor += c._subH + GAP_Y; });
    }
  }

  function computeBounds(nodes){
    let minX=Infinity,maxX=-Infinity,minY=Infinity,maxY=-Infinity;
    nodes.forEach(n=>{
      minX = Math.min(minX, (FLOW==='rtl'? n.x - n.width : n.x));
      maxX = Math.max(maxX, (FLOW==='rtl'? n.x : n.x + n.width));
      minY = Math.min(minY, n.y - n.height/2);
      maxY = Math.max(maxY, n.y + n.height/2);
    });
    return { w: (maxX - minX) + 120, h: (maxY - minY) + 120, minX, maxX };
  }

  // Zoom state
  let mode = 'fitW';
  let userScale = 1;
  let fitScaleW = 1;

  function applyZoom(){
    const s = (mode==='fitW') ? fitScaleW : userScale;
    stage.style.transform = `scale(${s})`;
    document.getElementById('zoomPct').textContent = Math.round(s*100) + '%';
  }

  function layout(animate=false){
    measure(root); subHeight(root); position(root, 0, 0);

    let nodes=[]; (function collect(n){nodes.push(n); if(!n.collapsed) n.children.forEach(collect);})(root);
    const { w, h, minX } = computeBounds(nodes);

    // size the canvas exactly to content bounds
    stage.style.width = Math.max(700, Math.ceil(w)) + 'px';
    stage.style.height = Math.max(420, Math.ceil(h)) + 'px';

    const offsetX = -minX + 60; // pack against right edge (RTL)

    nodes.forEach(n=>{
      const left = offsetX + (FLOW==='rtl' ? (n.x - n.width) : n.x);
      const top  = n.y - n.height/2;
      n.el.style.left = left + 'px';
      n.el.style.top  = top + 'px';
      if(n.children.length) n.el.setAttribute('aria-expanded', String(!n.collapsed));
      if(animate){ n.el.classList.add('appear'); setTimeout(()=> n.el.classList.remove('appear'), 240); }
    });

    edgeLayer.innerHTML='';
    (function drawEdges(n){ if(n.collapsed) return; n.children.forEach(ch=>{
      const p1x = offsetX + n.x; const p2x = offsetX + ch.x; const p1y = n.y; const p2y = ch.y;
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('class','edge'); path.setAttribute('d', `M ${p1x} ${p1y} C ${p1x + (FLOW==='rtl'?-1:1)*Math.abs(p2x-p1x)*.45} ${p1y}, ${p2x - (FLOW==='rtl'?-1:1)*Math.abs(p2x-p1x)*.45} ${p2y}, ${p2x} ${p2y}`);
      edgeLayer.appendChild(path);
      drawEdges(ch);
    }); })(root);

    // Fit-to-width strictly by content bounds (no scrollWidth glitches)
    const vpW = viewport.getBoundingClientRect().width;
    fitScaleW = Math.min(1, vpW / (w + 4));
    if(mode==='fitW') applyZoom();
  }

  // Zoom controls
  document.getElementById('zoomIn').addEventListener('click', ()=>{ mode='free'; userScale=Math.min(3, userScale*1.1); applyZoom(); });
  document.getElementById('zoomOut').addEventListener('click', ()=>{ mode='free'; userScale=Math.max(0.2, userScale/1.1); applyZoom(); });
  document.getElementById('zoomPct').addEventListener('click', ()=>{ mode='free'; userScale=1; applyZoom(); });
  document.getElementById('fitW').addEventListener('click', ()=>{ mode='fitW'; layout(false); });

  // Initial layout — hide, layout, fit, then reveal (no 13% flicker)
  function firstPaint(){ layout(false); stage.style.opacity=1; }
  // Run ASAP, then after fonts, then after next frame (for Moodle/Campus containers)
  layout(false);
  if(document.fonts && document.fonts.ready){ document.fonts.ready.then(()=> layout(false)); }
  requestAnimationFrame(()=> layout(false));
  setTimeout(firstPaint, 60);

  // Re-fit when container resizes / collapses / sidebars move
  const ro = new ResizeObserver(()=> layout(false));
  ro.observe(viewport); ro.observe(document.body);
  window.addEventListener('resize', ()=> layout(false));
})();
</script>
</body>
</html>
