<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>הרב זקס – חלון להגות יהודית — Mind‑Map Standalone</title>
<link href="https://fonts.googleapis.com/css2?family=Alef:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --gap-between-mods-d2:40px; /* הוגדל בעוד 20px */ /* תוספת מרחק בין מודולות (כשמפה פתוחה) כדי להגיע ~90px ממרכז למרכז בין פריט ד2 אחרון לראשון הבא */
    --font:'Alef', system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    --bg:#ffffff; --ink:#0f172a;
    --chip-h:48px; 
    --col-step:400px;       /* מרחק אופקי בין עמודות כלליות */
    --col-step-d23:400px;    /* להאריך חיבור 2↔3 כדי שלא ייראה פנימי */    /* מרחק בין עמודות 2↔3 – מיושר לעמודות אחרות */    /* מרחק בין עמודות 2↔3 (קטגוריה→פריט) */
    --gap-x:36px;           /* מרווח אופקי נוסף */
    --gap-y:40px; --gap-rootcat:22px; /* עומק 1: 70px center-to-center (48+22) */ 
    --gap-d3:22px;        /* עומק 3: 70px center-to-center (48+22) */        /* מרווח עומק 3 */
    --gap-d4:22px;        /* עומק 4: 70px center-to-center (48+22) */        /* מרווח עומק 4 */
    --gap-cat:22px;        /* עומק 2: 70px center-to-center (48+22) */        /* מרווח בין קבוצות/קטגוריות (עומק 2) */
    --gap-item:6px;        /* עומק 3+ צמוד יותר */        /* מצמצם עוד את ריווח עומק 3+ */        /* מרווח מצומצם יותר בין פריטים (עומק 3) */        /* מרווח בין פריטים באותה קטגוריה (עומק 3) – מצומצם */        /* מרווח בין פריטים באותה קטגוריה (עומק 3) */
    --r:9999px; --shadow:0 8px 22px rgba(0,0,0,.10);
    --edge:#C5CBD8; --toggle:#fe0100;
    --anim-dur:.60s; --anim-ease:ease-in-out; /* פתיחה וסגירה זהות */
    /* --col-step-d34: disabled */    /* מרחק בין עמודות 3↔4 – כדי להאריך קווים */
    /* --spine-dx: disabled */      /* מרחק אופקי של עמוד השדרה מההורה */
    --fit-margin:32;        /* רווח ביטחון לרוחב ב-Fit (px) */
    --nudge-d2-root0-px:35;  /* דחיפת ימין (פיקסלים) ל"מפת למידה"/"סילבוס" תחת 0 – ברוכים הבאים */        /* רווח ביטחון לרוחב ב-Fit (px) */
  }
  *{box-sizing:border-box}
  /* החלת גופן Alef בכל הממשק */
  html, body, button, input, select, textarea, .chip, .zoombar, .zoombar button, .pct, .label { font-family: var(--font) !important; }
  html,body{height:auto;min-height:100%; overflow-x:hidden}
  body{margin:0;background:var(--bg);color:var(--ink);} 
  .wrap{padding:12px; width:100%; max-width:none; margin:0 auto; overflow:visible}

  /* שורת כפתורים מופרדת מעל המפה */
  .zoombar{position:sticky; top:8px; inset-inline:0; display:flex; justify-content:center; align-items:center; gap:6px; z-index:3;
    /* glassy pill */
    background:rgba(255,255,255,.85); backdrop-filter:saturate(180%) blur(10px);
    padding:10px 12px; margin:0 auto 16px; width:max-content; border-radius:14px; 
    border:1px solid rgba(15,23,42,.06); box-shadow:0 8px 24px rgba(0,0,0,.10)}
  .zoombar button{border:1px solid rgba(15,23,42,.08); border-radius:12px; height:36px; padding:0 12px; font-family:inherit; font-weight:800; cursor:pointer; 
    background:linear-gradient(180deg,#ffffff,#f7f7f9); box-shadow:0 4px 12px rgba(0,0,0,.08);
    display:inline-flex; align-items:center; justify-content:center; gap:8px; transition:transform .12s ease, box-shadow .12s ease, background .12s ease}
  .zoombar button:hover{box-shadow:0 8px 18px rgba(0,0,0,.12)}
  .zoombar button:active{transform:translateY(1px)}
  .zoombar button:focus-visible{outline:3px solid rgba(59,130,246,.5); outline-offset:2px}
  .zoombar .pct{min-width:72px; text-align:center; border-radius:9999px; background:#f3f4f6; border:1px solid rgba(15,23,42,.08); height:36px; display:inline-flex; align-items:center; justify-content:center}
  /* round buttons for + / - */
  #zoomIn,#zoomOut{width:36px; padding:0; border-radius:9999px}
  /* primary accent for Fit */
  #fitW{background:linear-gradient(180deg,#fafafa,#eeeeff);}
  /* group spacing correction on small screens */
  @media (max-width:680px){.zoombar{width:calc(100% - 24px); justify-content:space-between}}
  .zoombar .pct{min-width:68px; text-align:center}

  /* במה */
  .viewport{position:relative; width:100%; height:auto; overflow:hidden; touch-action:none; cursor:grab}
  .scroller{position:relative;}
  .stage{position:relative; min-height:380px; min-width:0; transform-origin: top right; opacity:0}
  .chips{position:absolute; inset:0; z-index:1}
  svg{position:absolute; inset:0; width:100%; height:100%; overflow:visible; z-index:0}

  /* Capsules */
  .chip{position:absolute; display:inline-flex; align-items:center; flex-direction:row-reverse; height:var(--chip-h); padding:0 16px; border-radius:var(--r);
        line-height:1; white-space:nowrap; box-shadow:var(--shadow),inset 0 1px 0 rgba(255,255,255,.6);
        direction: rtl; text-align:right; font-weight:700; gap:14px;
        background: var(--chip-bg, #ffffff); color:#0f172a;}
  .chip[data-kind="root"]{font-weight:800}
  .label{pointer-events:none}

  /* Toggle */
  .toggle{position:relative; width:28px;height:28px;border-radius:50%;flex:0 0 auto;background:var(--toggle); cursor:pointer; border:0}
  .toggle .bar{position:absolute; left:50%; top:50%; width:14px; height:2px; background:#fff; border-radius:2px; transform:translate(-50%,-50%); transition: opacity var(--anim-dur) var(--anim-ease)}
  .toggle .bar.v{transform:translate(-50%,-50%) rotate(90deg); transition: opacity var(--anim-dur) var(--anim-ease)}
  .chip[aria-expanded="true"] .toggle .bar.v{opacity:0}

  .edge{fill:none; stroke:var(--edge); stroke-width:2; stroke-linecap:round}

  /* Fades */
  .fade-enter{ opacity:0.001 }
  .fade-enter.fade-active{ opacity:1; transition: opacity var(--anim-dur) var(--anim-ease) }
  .fade-exit{ opacity:1 }
  .fade-exit.fade-active{ opacity:0; transition: opacity var(--anim-dur) var(--anim-ease) }

  @media (prefers-reduced-motion: reduce){
    .fade-enter.fade-active,.fade-exit.fade-active{transition:none}
  }

  @media (max-width:900px){:root{--chip-h:44px; --col-step:340px}}
</style>
</head>
<body>
<div class="wrap">
  <!-- שורת הכפתורים נמצאת מחוץ ל-viewport כדי שלא תעלה על המפה -->
  <div class="zoombar" aria-label="Zoom controls">
    <button id="fitW" title="התאם לרוחב">↔︎ התאמה</button>
    <button id="zoomOut" title="Zoom out">−</button>
    <button id="zoomPct" class="pct" title="100%">100%</button>
    <button id="zoomIn" title="Zoom in">+</button>
    <button id="expandAll" title="פתח הכל">פתח־הכל</button>
    <button id="collapseAll" title="סגור הכל">סגור־הכל</button>
  </div>

  <div id="viewport" class="viewport">
    <div id="scroller" class="scroller">
      <div id="app" class="stage">
        <svg id="edges" aria-hidden="true"></svg>
        <div id="chips" class="chips"></div>
      </div>
    </div>
  </div>
</div>

<!-- === DATA (הרב זקס) === -->
<script id="mindmap-data" type="application/json">
{
  "dir": "rtl",
  "flow": "rtl",
  "root": {
    "label": "הרב זקס - חלון להגות יהודית",
    "children": [
      {"label":"0 - ברוכים הבאים","children":[
        {"label":"מפת למידה"},
        {"label":"סילבוס"},
        {"label":"למה הרב זקס? למה עכשיו?"},
        {"label":"ברכת נשיא המדינה"}
      ]},

      {"label":"1 – ביוגרפיה","children":[
        {"label":"רקע ביוגרפי והשפעתו על הגות הרב זקס"},
        {"label":"מנהיגות ומורשת הרב זקס"},
        {"label":"מבוא להגות הרב זקס"},
        {"label":"מה נלמד?","children":[
          {"label":"חקר ביוגרפי"},
          {"label":"עיצוב תפיסת עולם"},
          {"label":"מודל מנהיגותי"},
          {"label":"התבוננות מחודשת בזהות יהודית ומנהיגות במאה ה-21"}
        ]}
      ]},

      {"label":"מודולה 2 – יסודות פילוסופיים","children":[
        {"label":"מבוא לפילוסופיה יהודית"},
        {"label":"חקר האחריות והמחשבה היהודית"},
        {"label":"כשלון הנאורות"},
        {"label":"מסורת בעידן לא מסורתי"},
        {"label":"מה נלמד?","children":[{"label":"הגדרת הפילוסופיה היהודית, התפתחותה ההיסטורית והאינטלקטואלית, ומיקומו של הרב יונתן זקס בהקשר הפילוסופי־יהודי העכשווי"},{"label":"האחריות כמסגרת אתית: מה מציעה הפילוסופיה היהודית להבנת האחריות בעולם המודרני"},{"label":"בין מסורת למודרניות: איך מנהלים דיאלוג פורה בין המסורת היהודית לבין האתגרים של העידן הפוסט-מסורתי"},{"label":"הביקורת על הנאורות: מהן ההשלכות של כישלון פרויקט הנאורות על חקר המחשבה היהודית ועל רלוונטיות המקורות היהודיים"},{"label":"המחשבה היהודית ככלי פעיל: כיצד הופכת המחשבה היהודית מאוסף ידע היסטורי לכלי עכשווי לפתרון דילמות מודרניות"}]}
      ]},

      {"label":"מודולה 3 – המתודה הפרשנית","children":[
        {"label":"מבוא לפרשנות עפ\"י הרב זקס"},
        {"label":"מרבנות לפילוסופיה"},
        {"label":"פרופ' חנוך בן פזי על אתגרי הפרשנות הטקסטואלית"},
        {"label":"גישה פרשנית לטקסטים קשים"},
        {"label":"חומר קריאה: לא בשם האל"},
        {"label":"מה נלמד?","children":[
          {"label":"עקרון הסינתזה הדיסציפלינרית: איך משלבים רבנות ופילוסופיה בפרשנות טקסט"},
          {"label":"עקרון הפרשנות האחראית: כיצד נמנעים מפרשנות לא אתית של טקסטים דתיים"},
          {"label":"עקרון האיזון בין נאמנות לרלוונטיות: איך משמרים אותנטיות תוך יצירת משמעות מודרנית"},
          {"label":"עקרון הבנייה הבונה מתוך האתגר: כיצד הופכים קושי פרשני לכלי מוסרי"}
        ]}
      ]},

      {"label":"מודולה 4 – מטקסט לדיאלוג","gap":22,"children":[
        {"label":"פרופ' יונתן רינהולד על חזונו של הרב זקס: דיאלוג בין אמונה וחברה"},
        {"label":"דיאלוג בין אמונה וחברה"},
        {"label":"השפעת רוזנצוויג על הגות הרב זקס"},
        {"label":"מסורת בעידן לא מסורתי"},
        {"label":"תורה וחכמה — היהדות והעולם"},
        {"label":"מה נלמד?","children":[
          {"label":"דיאלוג בין אמונה לחברה – עקרון יסוד בהגותו של הרב יונתן זקס: דיאלוג בין אמונה דתית לבין החברה הפלורליסטית-מודרנית כמסגרת הכרחית לחיים מוסריים וחברתיים משותפים"},
          {"label":"שמירת המסורת בעידן מודרני – מודל המאפשר למסורת להמשיך להיות רלוונטית, מחייבת ויצירתית גם בתקופה של חילון ושינוי מתמיד"},
          {"label":"תורה וחכמה – הפריה הדדית בין התורה כקול זהות יהודית פרטיקולרית לבין החכמה האוניברסלית; סינתזה שבה זהות דתית מובחנת משתלבת בתרומה אוניברסלית"},
          {"label":"יסודות פילוסופיים – השפעת פרנץ רוזנצוויג ועקרון הדיאלוג וחיי המפגש; הממד הביקורתי כלפי הנאורות כבסיס לחשיבה יהודית מחודשת"}
        ]}
      ]},

      {"label":"מודולה 5 – מדע, מודרניות ומנהיגות","children":[
        {"label":"מודרניות וחברה"},
        {"label":"מודרניות ומנהיגות בחברה"},
        {"label":"מאמר — בלשון העתיד"},
        {"label":"תפקיד הרב הראשי של אנגליה"},
        {"label":"לורד דוד וולפסון על מורשת והשפעה"},
        {"label":"מאמר: חלומות ומציאות — שיחה עם עמוס עוז"},
        {"label":"מדע ודת"},
        {"label":"מדע, אמונה וקיימות — פרופ' אריה צבן"},
        {"label":"מה נלמד?","children":[
          {"label":"יישומי הגותו של הרב זקס במדע, חברה ומנהיגות, וזיהוי הקשרים הרעיוניים בין התחומים"},
          {"label":"ההשפעה המעשית של רעיונותיו על מבנים חברתיים, מוסדות ציבור ותהליכי קבלת החלטות"},
          {"label":"כישורי ניתוח וחשיבה ביקורתית: הבחנה בין עקרונות תיאורטיים ליישומים מעשיים בהגותו"},
          {"label":"הבנה היסטורית ועכשווית של תרומתו לשיח המדע, הדת והחברה ומיקומו באקוסיסטם האינטלקטואלי"}
        ]}
      ]},

      {"label":"מודולה 6 – מורשת חיה","children":[
        {"label":"מורשת הרב זקס והשפעותיה"},
        {"label":"פרופ׳ אדם פרזינגר — כיצד הפך הרב זקס לתופעה תרבותית בישראל?"},
        {"label":"הרב דניאל אפשטיין — מציטוטים על הקיר למדף הספרים"},
        {"label":"ד״ר חיים נריה — הצצה לארכיון ולמורשתו של הרב זקס"},
        {"label":"ג׳ואנה בן הרוש על מורשת הרב זקס"},
        {"label":"ג׳ואנה גרינווי — חינוך, מנהיגות וזהות יהודית בעידן מודרני"},
        {"label":"מאמר: רדיקלית אז, רדיקלית עכשיו"},
        {"label":"מה נלמד?","children":[
          {"label":"תהליך הפיכתו של הרב זקס לדמות תרבותית משפיעה בשיח הציבורי בישראל"},
          {"label":"חדירת רעיונותיו מן היומיומי אל השדה ההגותי והספרותי"},
          {"label":"תרומת הארכיון – מרחב לשימור, המשכיות והנחלת המורשת"},
          {"label":"השפעת המורשת על חינוך, זהות ומנהיגות יהודית בעידן מודרני"},
          {"label":"עיון במאמר ‘רדיקלית אז, רדיקלית עכשיו’ כהמשגה של המסורת ככוח להתחדשות"}
        ]}
      ]},

      {"label":"מודולה 7 – סיכום","children":[
        {"label":"הרב יונתן זקס — חלון לעולם של ערכים, זהות ומנהיגות יהודית"},
        {"label":"פרויקט מסכם"}
      ]}
    ]
  }
}
</script>

<script>
(function(){
  let data; try{ data = JSON.parse(document.getElementById('mindmap-data').textContent); }catch(e){ console.error('Mindmap JSON parse error:', e); data = {"dir":"rtl","flow":"rtl","root":{"label":"שגיאת נתונים – נא לבדוק JSON","children":[]}}; }

  const DIR = (data.dir||'rtl'); document.documentElement.setAttribute('dir', DIR);
  const FLOW = (data.flow||'rtl');
  const viewport = document.getElementById('viewport');
  // ננטרל השפעות RTL על גלילה כדי שמרכזון יעבוד תמיד
  if(viewport) viewport.style.direction = 'ltr';
  const stage = document.getElementById('app');
  const scroller = document.getElementById('scroller');
  const chipLayer = document.getElementById('chips');
  const edgeLayer = document.getElementById('edges');

  // מצב זום גלובלי
  let mode = 'fitW';
  let userScale = 1;
  let lockedFit = 1;

  // אין צורך ב-SAFE_TOP כי הסרגל מחוץ ל-viewport
  function updateSafeTop(){ if(viewport) viewport.style.paddingTop = '0px'; if(scroller) scroller.style.marginTop = '0px'; }

  if(DIR==='ltr'){ stage.style.transformOrigin = 'top left'; stage.style.left='0'; }
  else { stage.style.transformOrigin = 'top right'; stage.style.right='0'; }
  stage.style.top='0'; stage.style.position='absolute';

  const CSS = getComputedStyle(document.documentElement);
  const CHIP_H  = parseFloat(CSS.getPropertyValue('--chip-h'))   || 48;
  const COL_STEP= parseFloat(CSS.getPropertyValue('--col-step')) || 400;
  const COL_STEP_D23 = parseFloat(CSS.getPropertyValue('--col-step-d23')) || COL_STEP;
  // COL_STEP_D34 removed
  const GAP_X   = parseFloat(CSS.getPropertyValue('--gap-x'))    || 36; 
  const GAP_Y   = parseFloat(CSS.getPropertyValue('--gap-y'))    || 40;  // root / כלליים
  const GAP_BETWEEN_MODS_D2 = parseFloat(CSS.getPropertyValue('--gap-between-mods-d2')) || 20;
  const GAP_ROOTCAT = parseFloat(CSS.getPropertyValue('--gap-rootcat')) || 140; // בין פרקי-על (depth 1)
  const GAP_CAT = parseFloat(CSS.getPropertyValue('--gap-cat'))  || 110; // בין קטגוריות (depth 2)
  const GAP_ITEM= parseFloat(CSS.getPropertyValue('--gap-item')) || 36;  // ברירת מחדל
  const GAP_D3 = parseFloat(CSS.getPropertyValue('--gap-d3')) || GAP_ITEM;
  const GAP_D4 = parseFloat(CSS.getPropertyValue('--gap-d4')) || GAP_ITEM;
  const NUDGE_D2_ROOT0_PX = parseFloat(CSS.getPropertyValue('--nudge-d2-root0-px')) || 0;

  const DEPTH_COLORS = {0:'#F8E8FF', 1:'#EBDCF8', 2:'#D4D2E6', 3:'#D7F6E4', 4:'#50E38A'};
  const DEPTH_FIXED_WIDTH = false; // שומרים על רוחב טבעי לפי הטקסט // קיבוע רוחב לפי עומק ליישור עמודה

  function build(raw, depth=0, parent=null){
    const node = { label: raw.label, depth, parent, collapsed: !!raw.collapsed, x:0,y:0,width:0,height:CHIP_H, el:null, id: Math.random().toString(36).slice(2), _subH:0, children: [], gapOverride: (typeof raw.gap==='number'? raw.gap : null) };
    (raw.children||[]).forEach(ch=> node.children.push(build(ch, depth+1, node)));
    return node;
  }
  const root = build(data.root, 0, null);

  function gapForDepth(depth){
    if(depth>=4) return GAP_D4;          // עומק 4
    if(depth===3) return GAP_D3;         // עומק 3
    if(depth===2) return GAP_CAT;        // קטגוריות (עומק 2)
    if(depth===1) return GAP_ROOTCAT;    // פרקי-על (עומק 1)
    return GAP_Y;                        // שורש
  }

  function collapseDeep(n){ n.collapsed = true; n.children.forEach(c=>collapseDeep(c)); }

  let openingNode = null; // מי נפתח כעת
  let edgeOf = new Map();
  const PAD = 6; // מרחק מהקפסולה לקו // childId -> path element
  let prevVisibleIds = new Set();
  let LAYOUT_MAX_DEPTH = 0; // זיכרון הנראים מהלייאאוט הקודם
  let lastW = 0, lastH = 0; // ממדי לייאאוט אחרונים (לסקייל/גלילה)
  function applyZoom(){
    const s = (mode==='fitW') ? lockedFit : userScale;
    stage.style.transform = `scale(${s})`;
    const pct = document.getElementById('zoomPct'); if(pct) pct.textContent = Math.round(s*100)+"%";
    if(lastW && lastH){
      const wpx = (mode==='fitW') ? Math.floor(viewport.clientWidth) : Math.ceil(lastW * s);
      scroller.style.width  = wpx + 'px';
      scroller.style.height = Math.ceil(lastH * s) + 'px';
    }
    const tol = 2;
    let needX = (mode!=='fitW') && ((scroller.offsetWidth - viewport.clientWidth) > tol);
    let needY = (scroller.offsetHeight - viewport.clientHeight) > tol;
    if(mode==='fitW'){
      needX = false;
      if(lastH && (lastH * Math.max(lockedFit, 0.0001) <= viewport.clientHeight - tol)) needY = false;
    }
    viewport.style.overflowX = needX ? 'auto' : 'hidden';
    viewport.style.overflowY = needY ? 'auto' : 'hidden';
    viewport.style.cursor    = (needX || needY) ? 'grab' : 'auto';
  }
  // פונקציית מרכזון בסיסית – ממרכזת אופקית ואנכית באמצעות גלילה
  function centerOn(){
    try{
      const targetL = Math.max(0, (scroller.scrollWidth  - viewport.clientWidth ) / 2);
      const targetT = Math.max(0, (scroller.scrollHeight - viewport.clientHeight) / 2);
      viewport.scrollLeft = targetL;
      viewport.scrollTop  = targetT;
    }catch(_){ }
  }

  let offsetX = 0, stageW = 0; // למניעת ReferenceError
  // מצב פאנינג ומדידת גובה זמין
  let isPanning=false, panPending=false, startX=0, startY=0, startScrollL=0, startScrollT=0; const DRAG_T=4;
  let pinchStartDist=0, pinchStartScale=1;
  function sizeViewport(){
    const rect = viewport.getBoundingClientRect();
    const avail = window.innerHeight - rect.top - 16; // שוליים תחתונים קטנים
    viewport.style.height = Math.max(320, Math.floor(avail)) + 'px';
  }

  function isDescendant(node, anc){ let p=node.parent; while(p){ if(p===anc) return true; p=p.parent; } return false; }

  // דחיפה אופקית (פיקסלים) לפריטים ספציפיים בעומק 2 תחת "0 - ברוכים הבאים"
  function extraRightPx(n){
    try{
      if(n.depth===2 && n.parent && typeof n.parent.label==='string' && n.parent.label.indexOf('0 - ')===0){
        if(n.label==='מפת למידה' || n.label==='סילבוס') return NUDGE_D2_ROOT0_PX;
      }
    }catch(_){ }
    return 0;
  }

  function makeToggle(){
    const btn = document.createElement('button');
    btn.className = 'toggle'; btn.setAttribute('aria-label','פתח/סגור');
    btn.innerHTML = '<i class="bar h"></i><i class="bar v"></i>';
    return btn;
  }

  function ensureChip(node){
    if(node.el) return;
    const el = document.createElement('div'); el.className = 'chip';
    el.dataset.kind = node.depth===0 ? 'root' : (node.children.length? 'cat':'leaf');
    const label = document.createElement('span'); label.className='label'; label.textContent=node.label; el.appendChild(label);
    if(node.children.length){
      const t = makeToggle(); el.appendChild(t);
      el.setAttribute('aria-expanded', String(!node.collapsed));
      t.addEventListener('click', ev => { ev.stopPropagation(); handleToggle(node); });
      el.setAttribute('tabindex','0'); el.setAttribute('role','button');
      el.addEventListener('keydown', ev=>{ if(ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); handleToggle(node); } });
    }
    const base = DEPTH_COLORS[Math.min(node.depth,4)] || DEPTH_COLORS[4];
    el.style.setProperty('--chip-bg', base);
    chipLayer.appendChild(el); node.el=el;
  }
  (function collect(n){ ensureChip(n); n.children.forEach(collect); })(root);

  function measure(node){
    node.el.style.left = '-10000px';
    node.el.style.top = '-10000px';
    // מדידה טבעית
    const natural = Math.max(140, node.el.offsetWidth);
    node.width = natural;
    node.children.forEach(measure);
  }
  function subHeight(node){
    if(node.collapsed || node.children.length===0){ node._subH = node.height; return node._subH; }
    let total = 0;
    node.children.forEach((c,i)=>{
      subHeight(c);
      total += c._subH;
      if(i>0){
        const localGap = (node.gapOverride != null) ? node.gapOverride : gapForDepth(c.depth);
        total += localGap;
      }
    });
    node._subH = Math.max(node.height, total); return node._subH;
  }

  function xForDepth(depth){
    let acc = 0;
    for(let i=0;i<depth;i++){
      const step = (i===2 ? COL_STEP_D23 : COL_STEP);
      acc += (step + GAP_X);
  }
    return acc * (FLOW==='rtl' ? -1 : 1);
  }

  function position(node, depth, top){
    node.x = xForDepth(depth);
    node.y = top + node._subH/2;
    if(!(node.collapsed) && node.children.length){
      let cursor = top;
      node.children.forEach((c,idx)=>{
        position(c, depth+1, cursor);
        cursor += c._subH + gapForDepth(c.depth);
        // תוספת בין מודולות: אם ההורה הוא השורש (depth 0) ויש עוד מודולה הבאה,
        // ובאופן כללי המפה פתוחה (יש עומק >1), הוסף רווח נוסף כדי לקבל ~90px בין ד2 אחרון לראשון הבא
        if(node.depth===0 && idx < node.children.length-1){
          if(LAYOUT_MAX_DEPTH > 1){ cursor += GAP_BETWEEN_MODS_D2; }
        }
      });
    }
  }
  function collectVisible(n, arr){ arr.push(n); if(!n.collapsed) n.children.forEach(ch=>collectVisible(ch, arr)); }
  function computeBounds(nodes){
    let minX=Infinity,maxX=-Infinity,minY=Infinity,maxY=-Infinity;
    nodes.forEach(n=>{
      const left  = (FLOW==='rtl' ? n.x - n.width : n.x);
      const right = (FLOW==='rtl' ? n.x : n.x + n.width);
      minX = Math.min(minX, left);
      maxX = Math.max(maxX, right);
      minY = Math.min(minY, n.y - n.height/2);
      maxY = Math.max(maxY, n.y + n.height/2);
    });
    const MARG = 0;
    return { w: (maxX - minX) + MARG, h: (maxY - minY) + MARG, minX };
  }

  function layout(animate=false){
    // מדידה והעמדה
    measure(root);
    // חשב עומק מקסימלי נראה לפני מיקום כדי שהריווח בין-מודולות יהיה מדויק
    LAYOUT_MAX_DEPTH = 0;
    (function calcDepth(n){ LAYOUT_MAX_DEPTH = Math.max(LAYOUT_MAX_DEPTH, n.depth); if(!n.collapsed) n.children.forEach(calcDepth); })(root);

    subHeight(root); position(root, 0, 0);

    let nodes=[]; collectVisible(root, nodes);
    const { w, h, minX } = computeBounds(nodes);

    const vpW = viewport.getBoundingClientRect().width;
    const FIT_MARGIN = parseFloat(CSS.getPropertyValue('--fit-margin')) || 24;
    const baseFit = Math.min(1.0, (vpW - FIT_MARGIN) / Math.max(1, w));
    const maxDepthVis = nodes.reduce((m,n)=> Math.max(m, n.depth), 0);
    let compactCap = 1.0;
    if (maxDepthVis <= 1) compactCap = 0.75; else if (maxDepthVis === 2) compactCap = 0.88;
    const requiredFit = Math.max(0.2, Math.min(baseFit, compactCap));
    if(mode==='fitW'){
      lockedFit = requiredFit;
      const RIGHT_PAD_PX = 24; const LEFT_PAD_PX = 24;
      const rightPadUnits = RIGHT_PAD_PX / Math.max(lockedFit, 0.0001);
      const leftPadUnits  = LEFT_PAD_PX  / Math.max(lockedFit, 0.0001);
      offsetX = -minX + leftPadUnits;
      stageW  = w + leftPadUnits + rightPadUnits;
    } else {
      const scaleNow = Math.max((mode==='fitW') ? lockedFit : userScale, 0.0001);
      const desiredPad = Math.max(60, Math.floor((viewport.clientWidth/scaleNow - w)/2) + 40);
      const padSide = desiredPad;
      offsetX = -minX + padSide;
      stageW  = w + padSide*2;
    }

    lastW = stageW; lastH = h;
    stage.style.width  = Math.ceil(stageW) + 'px';
    stage.style.height = Math.ceil(h) + 'px';

    // מיקום קפסולות — יישור ימני קשיח עם snap אחרי scale למניעת סטיות סאב-פיקסל
    const sPlace = (mode==='fitW') ? lockedFit : userScale;
    nodes.forEach(n=>{
      const top  = n.y - n.height/2;
      // right in pixels (after scale), snapped to integer
      const rightPx = Math.round((offsetX + n.x) * sPlace) + extraRightPx(n);
      const leftUnits = (rightPx / Math.max(sPlace,0.0001)) - n.width;
      n.el.style.left = leftUnits + 'px';
      n.el.style.right = '';
      n.el.style.top  = top + 'px';
      if(n.children.length){ n.el.setAttribute('aria-expanded', String(!n.collapsed)); }
    });

    // שרטוט קווים
    edgeOf.clear(); edgeLayer.textContent='';
    (function drawEdges(n){ if(n.collapsed) return; n.children.forEach(ch=>{
      const PAD_PARENT = 6;  // ריווח קל מצד ההורה
      const PAD_CHILD  = 0;  // אין ריווח מצד הילד – הקו ייגע בקפסולה
      const parentLeft  = offsetX + (FLOW==='rtl' ? (n.x - n.width) : n.x);
      const parentRight = offsetX + (FLOW==='rtl' ? n.x : (n.x + n.width));
      // נקודת קצה הקו תשתמש באותו snap של שפת ימין כדי שלא יישאר רווח ויזואלי
      const sNow = ((mode==='fitW') ? lockedFit : userScale);
      const childEdge   = (Math.round((offsetX + ch.x) * sNow) + extraRightPx(ch)) / Math.max(sNow,0.0001);
      const p1x = (FLOW==='rtl' ? parentLeft  + PAD_PARENT : parentRight - PAD_PARENT);
      const p2x = (FLOW==='rtl' ? childEdge   - PAD_CHILD  : childEdge   + PAD_CHILD);
      const p1y = n.y; const p2y = ch.y;
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      const dx=Math.abs(p2x-p1x)*.45; const c1x=(FLOW==='rtl'? p1x-dx: p1x+dx); const c2x=(FLOW==='rtl'? p2x+dx: p2x-dx);
      path.setAttribute('class','edge'); path.setAttribute('d', `M ${p1x} ${p1y} C ${c1x} ${p1y}, ${c2x} ${p2y}, ${p2x} ${p2y}`);
      edgeOf.set(ch.id, path);
      edgeLayer.appendChild(path);
      drawEdges(ch);
    }); })(root);

    applyZoom();
    stage.style.opacity='1';
  }

  function animateClose(node, done){
    const list=[];
    function collectDesc(n){ if(!n || n.collapsed) return; list.push(n); n.children.forEach(collectDesc); }
    node.children.forEach(collectDesc);

    const dur = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--anim-dur'))*1000+20;
    list.forEach(n=>{
      if(n.el){ n.el.classList.add('fade-exit'); requestAnimationFrame(()=> n.el.classList.add('fade-active')); setTimeout(()=> n.el.classList.remove('fade-exit','fade-active'), dur); }
      const edge = edgeOf.get(n.id); if(edge){ edge.classList.add('fade-exit'); requestAnimationFrame(()=> edge.classList.add('fade-active')); setTimeout(()=> edge.classList.remove('fade-exit','fade-active'), dur); }
    });
    setTimeout(done, dur);
  }

  function handleToggle(n){
    if(n.collapsed){
      if(n.el) n.el.setAttribute('aria-expanded','true');
      openingNode = n;
      n.collapsed = false;
      layout(true);
    } else {
      if(n.el) n.el.setAttribute('aria-expanded','false');
      animateClose(n, ()=>{ collapseDeep(n); layout(false); });
    }
  }

  // Zoom & actions
  const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
  const currentScale = ()=> (mode==='fitW' ? lockedFit : userScale);

  document.getElementById('zoomIn').addEventListener('click', ()=>{
    const base = (mode==='fitW') ? lockedFit : userScale;
    mode='free';
    userScale = clamp(base + 0.10, 0.2, 3);
    applyZoom();
  });
  document.getElementById('zoomOut').addEventListener('click', ()=>{
    const base = (mode==='fitW') ? lockedFit : userScale;
    mode='free';
    userScale = clamp(base - 0.10, 0.2, 3);
    applyZoom();
  });
  document.getElementById('zoomPct').addEventListener('click', ()=>{ mode='free'; userScale=1; applyZoom(); });
  document.getElementById('fitW').addEventListener('click', ()=>{ mode='fitW'; layout(false); });

  function canPan(){
    const tol = 2;
    let needX = (mode!=='fitW') && ((scroller.offsetWidth - viewport.clientWidth) > tol);
    let needY = (scroller.offsetHeight - viewport.clientHeight) > tol;
    if(mode==='fitW'){
      needX = false;
      if(lastH && (lastH * Math.max(lockedFit, 0.0001) <= viewport.clientHeight - tol)){
        needY = false;
      }
    }
    return needX || needY;
  }
  viewport.addEventListener('pointerdown', e=>{
    if(e.button!==0) return;
    if(e.target && e.target.closest && (e.target.closest('.zoombar') || e.target.closest('.toggle'))) return;
    if(!canPan()) return;
    panPending = true;
    isPanning = false;
    startX = e.clientX; startY = e.clientY;
    startScrollL = viewport.scrollLeft; startScrollT = viewport.scrollTop;
  });
  viewport.addEventListener('pointermove', e=>{
    if(!(panPending || isPanning)) return;
    const dx = e.clientX - startX; const dy = e.clientY - startY;
    if(!isPanning){
      if(Math.abs(dx) + Math.abs(dy) < 4) return;
      isPanning = true;
      try{ viewport.setPointerCapture(e.pointerId);}catch(_){ }
      viewport.style.cursor = 'grabbing';
    }
    viewport.scrollLeft = startScrollL - dx;
    viewport.scrollTop = startScrollT - dy;
  });
  function endPan(){ panPending=false; isPanning=false; viewport.style.cursor = (canPan()? 'grab':'auto'); }
  viewport.addEventListener('pointerup', endPan);
  viewport.addEventListener('pointercancel', endPan);
  viewport.addEventListener('pointerleave', endPan);

  viewport.addEventListener('touchstart', e=>{
    if(e.target && e.target.closest && (e.target.closest('.zoombar') || e.target.closest('.toggle'))) return;
    if(e.touches.length===2){
      pinchStartDist = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      pinchStartScale = currentScale();
      mode='free';
    }
  }, {passive:true});
  viewport.addEventListener('touchmove', e=>{
    if(e.target && e.target.closest && (e.target.closest('.zoombar') || e.target.closest('.toggle'))) return;
    if(e.touches.length===2 && pinchStartDist>0){
      e.preventDefault();
      const dist = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      userScale = clamp(pinchStartScale * (dist / pinchStartDist), 0.2, 3);
      applyZoom();
    }
  }, {passive:false});
  viewport.addEventListener('touchend', e=>{ if(e.touches.length<2){ pinchStartDist=0; } });

  viewport.addEventListener('wheel', e=>{
    if(e.target && e.target.closest && (e.target.closest('.zoombar') || e.target.closest('.toggle'))) return;
    if(!e.ctrlKey) return; // Pinch on trackpad
    e.preventDefault();
    mode='free';
    const s = currentScale();
    userScale = clamp(s * Math.exp(-e.deltaY/500), 0.2, 3);
    applyZoom();
  }, {passive:false});

  document.getElementById('expandAll').addEventListener('click', ()=>{ (function open(n){ n.collapsed=false; n.children.forEach(open); })(root); layout(true); });
  document.getElementById('collapseAll').addEventListener('click', ()=>{
    (function close(n){ if(n!==root) n.collapsed=true; n.children.forEach(close); })(root);
    // עבור מיקום למרכז, נעבור למצב חופשי אך נשמור את אותו scale כמו fitW
    mode = 'free';
    userScale = lockedFit;
    layout(true);
    requestAnimationFrame(()=> centerOn(root));
  });

  // Initial layout — אין SAFE_TOP יותר
  updateSafeTop();
  sizeViewport();
  layout(false);
  window.addEventListener('resize', ()=>{ updateSafeTop(); sizeViewport(); layout(false); });

  // ריענון לייאאוט אחרי טעינת גופנים (Alef נטען אסינכרונית ועלול לשבור יישור ימני)
  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(()=>{ layout(false); });
    document.fonts.addEventListener?.('loadingdone', ()=> layout(false));
  }
})();
</script>
</body>
</html>
