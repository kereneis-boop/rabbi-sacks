<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>הרב זקס - חלון להגות יהודית — Mind-Map</title>
<link href="https://fonts.googleapis.com/css2?family=Alef:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    /* ריווחים והתאמה */
    --zoombar-gap: 36px;
    --map-pad-top: 32px;
    --map-pad-bottom: 40px;
    --fit-margin: 24;              /* שוליים ב-FIT מכל צד (פיקסלים) */
    --root-gutter: 20px;           /* מרווח מינ' מהשורש לימין (במצב FREE) */

    /* גיאומטריה של המפה */
    --chip-h:48px;
    --gap-x:36px;
    --gap-x-d01:100px;
    --gap-rootcat:22px;
    --gap-cat:22px;
    --gap-d3:22px;
    --gap-d4:22px;
    --gap-item:6px;
    --gap-between-groups:40px;

    /* עיצוב */
    --font:'Alef', system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    --bg:#ffffff; --ink:#0f172a;
    --edge:#C5CBD8; --toggle:#fe0100;
    --shadow:0 8px 22px rgba(0,0,0,.10);
    --r:9999px;

    --anim-dur:.55s;
    --anim-ease:ease-in-out;
  }

  *{box-sizing:border-box}
  html, body, button, .chip, .zoombar, .zoombar button, .pct, .label { font-family: var(--font) !important; }
  html,body{min-height:100%; overflow-x:hidden}
  body{margin:0;background:var(--bg);color:var(--ink);}
  .wrap{padding:12px; width:100%; margin:0 auto; overflow:visible}

  /* סרגל כפתורים */
  .zoombar{
    position:sticky; top:8px; inset-inline:0; z-index:3;
    display:flex; justify-content:center; align-items:center; gap:6px;
    background:rgba(255,255,255,.86); backdrop-filter:saturate(180%) blur(10px);
    padding:10px 12px; margin:0 auto var(--zoombar-gap);
    width:max-content; border-radius:14px;
    border:1px solid rgba(15,23,42,.06); box-shadow:0 8px 24px rgba(0,0,0,.10)
  }
  .zoombar button{
    border:1px solid rgba(15,23,42,.08); border-radius:12px; height:36px; padding:0 12px; font-weight:800; cursor:pointer;
    background:linear-gradient(180deg,#ffffff,#f7f7f9); box-shadow:0 4px 12px rgba(0,0,0,.08);
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    transition:transform .12s ease, box-shadow .12s ease, background .12s ease; touch-action:manipulation;
  }
  .zoombar button:hover{box-shadow:0 8px 18px rgba(0,0,0,.12)}
  .zoombar button:active{transform:translateY(1px)}
  .zoombar .pct{min-width:68px; height:36px; display:inline-flex; align-items:center; justify-content:center; border-radius:9999px; background:#f3f4f6; border:1px solid rgba(15,23,42,.08)}
  #zoomIn,#zoomOut{width:36px; padding:0; border-radius:9999px}
  #fitBtn{background:linear-gradient(180deg,#fafafa,#eeeeff);}

  /* במה + מרכוז */
  .viewport{
    position:relative; width:100%;
    overflow:hidden;                 /* ב-FIT אין גלילה, ב-FREE יש גלילה */
    touch-action:none; cursor:grab;
    scrollbar-gutter:stable;
    direction:ltr;                   /* נרמול scrollLeft */
  }
  .viewport.panning{ cursor:grabbing; }

  .scroller{
    position:relative;
    display:flex; justify-content:center; align-items:flex-start; /* מרכז אופקי */
    padding:0;                       /* נגדיר דינאמי ב-JS */
    min-width:100%;
  }

  .stage{
    position:relative;
    min-height:380px; min-width:0;
    transform-origin: top center;    /* זום סביב המרכז האופקי */
    opacity:0;
  }

  .chips{ position:absolute; inset:0; z-index:1; direction:rtl; }
  svg{ position:absolute; inset:0; width:100%; height:100%; overflow:visible; z-index:0 }

  /* קפסולות – לא נחתכות */
  .chip{
    position:absolute; display:inline-flex; align-items:center;
    height:var(--chip-h); padding:0 16px; border-radius:var(--r);
    line-height:1; white-space:nowrap; box-shadow:var(--shadow),inset 0 1px 0 rgba(255,255,255,.6);
    direction:rtl; text-align:right; font-weight:700; gap:14px;
    background: var(--chip-bg, #ffffff); color:#0f172a; cursor:pointer;

    overflow:visible !important; text-overflow:clip !important;
    max-width:none !important; width:auto !important; min-width:max-content;
  }
  .chip[data-kind="root"]{font-weight:800}
  .label{ pointer-events:none; direction:rtl; text-align:right; white-space:nowrap !important; overflow:visible !important; }

  .chip .toggle{margin-inline-start:auto; flex:0 0 auto}
  .toggle{position:relative; width:28px; height:28px; border:0; border-radius:50%; background:var(--toggle); cursor:pointer}
  .toggle .bar{position:absolute; left:50%; top:50%; width:14px; height:2px; background:#fff; border-radius:2px; transform:translate(-50%,-50%); transition:opacity var(--anim-dur) var(--anim-ease)}
  .toggle .bar.v{transform:translate(-50%,-50%) rotate(90deg)}
  .chip[aria-expanded="true"] .toggle .bar.v{opacity:0}

  .edge{fill:none; stroke:var(--edge); stroke-width:2; stroke-linecap:round}

  .fade-enter{ opacity:0.001 }
  .fade-enter.fade-active{ opacity:1; transition: opacity var(--anim-dur) var(--anim-ease) }
  .fade-exit{ opacity:1 }
  .fade-exit.fade-active{ opacity:0; transition: opacity var(--anim-dur) var(--anim-ease) }

  @media (prefers-reduced-motion: reduce){
    .fade-enter.fade-active,.fade-exit.fade-active{transition:none}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="zoombar" aria-label="Zoom controls">
    <button id="fitBtn" title="התאם למסך">↔︎ התאמה</button>
    <button id="zoomOut" title="Zoom out">−</button>
    <button id="zoomPct" class="pct" title="100%">100%</button>
    <button id="zoomIn" title="Zoom in">+</button>
    <button id="expandAll" title="פתח הכל">פתח־הכל</button>
    <button id="collapseAll" title="סגור הכל">סגור־הכל</button>
  </div>

  <div id="viewport" class="viewport">
    <div id="scroller" class="scroller">
      <div id="app" class="stage">
        <svg id="edges" aria-hidden="true"></svg>
        <div id="chips" class="chips"></div>
      </div>
    </div>
  </div>
</div>

<!-- === DATA === -->
<script id="mindmap-data" type="application/json">
{
  "dir": "rtl",
  "flow": "rtl",
  "root": {
    "label": "הרב זקס - חלון להגות יהודית",
    "children": [
      { "label": "0 - ברוכים הבאים", "children": [
        { "label": "# הקדמה" },
        { "label": "1. למה הרב זקס, למה עכשיו? 2. מפת הקורס 3. סילבוס" },
        { "label": "כיצד לסיים את הקורס בהצלחה?" },
        { "label": "ערכים, זהות וחינוך יהודי במאה ה־21" }
      ]},
      { "label": "1 - ביוגרפיה", "children": [
        { "label": "#01 יסודות ביוגרפיים בהגות הרב זקס" },
        { "label": "גילה זקס - מבט אישי על התפתחות הרב זקס כפילוסוף והוגה יהודי" },
        { "label": "הרב דיין בינשטוק - מן הדרשה המקומית אל המורשת ההגותית" },
        { "label": "מה נלמד?", "children": [
          { "label": "1. חקר ביוגרפי" },
          { "label": "2. עיצוב תפיסת עולם" },
          { "label": "3. מודל מנהיגותי" },
          { "label": "4. התבוננות מחודשת בזהות יהודית ומנהיגות במאה ה-21" }
        ]}
      ]},
      { "label": "2 - יסודות פילוסופיים", "children": [
        { "label": "#02 יסודות פילוסופיים בהגות היהודית" },
        { "label": "פרופ׳ חנוך בן פזי - דיאלוגים פילוסופיים: חקר האחריות והמחשבה היהודית" },
        { "label": "מרציונליזם אוניברסלי לברית חברתית: ביקורת הנאורות עפ״י הרב זקס" },
        { "label": "הרב ד\"ר רפאל זארום: חקר המחשבה וההשפעה היהודית" },
        { "label": "מסורת בעידן לא מסורתי" },
        { "label": "הרב זקס: ללא מורא - העתיד כאתגר והזדמנות" },
        { "label": "מה נלמד?", "children": [
          { "label": "הגדרת הפילוסופיה היהודית, התפתחותה ההיסטורית והאינטלקטואלית, ומיקומו של הרב יונתן זקס בהקשר הפילוסופי־יהודי העכשווי" },
          { "label": "האחריות כמסגרת אתית: מה מציעה הפילוסופיה היהודית להבנת האחריות בעולם המודרני" },
          { "label": "בין מסורת למודרניות: איך מנהלים דיאלוג פורה בין המסורת היהודית לבין האתגרים של העידן הפוסט-מסורתי" },
          { "label": "הביקורת על הנאורות: מהן ההשלכות של כישלון פרויקט הנאורות על חקר המחשבה היהודית ועל רלוונטיות המקורות היהודיים" },
          { "label": "המחשבה היהודית ככלי פעיל: כיצד הופכת המחשבה היהודית מאוסף ידע היסטורי לכלי עכשווי לפתרון דילמות מודרניות" }
        ]}
      ]},
      { "label": "3 - המתודה הפרשנית", "children": [
        { "label": "#03 המתודה הפרשנית בהגות הרב זקס" },
        { "label": "הרב ד\"ר מייקל האריס - בין רבנות לפילוסופיה: מסעו של הרב זקס" },
        { "label": "פרופ׳ חנוך בן פזי - עיקרון הפרשנות כמעשה מוסרי בהגות הרב זקס" },
        { "label": "פרשנות טקסטים קשים בתורה כאתגר מוסרי ותיאולוגי" },
        { "label": "לא בשם האל" },
        { "label": "מה נלמד?", "children": [
          { "label": "עקרון הסינתזה הדיסציפלינרית: איך משלבים רבנות ופילוסופיה בפרשנות טקסט" },
          { "label": "עקרון הפרשנות האחראית: כיצד נמנעים מפרשנות לא אתית של טקסטים דתיים" },
          { "label": "עקרון האיזון בין נאמנות לרלוונטיות: איך משמרים אותנטיות תוך יצירת משמעות מודרנית" },
          { "label": "עקרון הבנייה הבונה מתוך האתגר: כיצד הופכים קושי פרשני לכלי מוסרי" }
        ]}
      ]},
      { "label": "4 - מטקסט לדיאלוג", "children": [
        { "label": "#04 דיאלוג בחברה מגוונת בעידן רב תרבותי" },
        { "label": "פרופ׳ ג׳ונתן ריינהולד - ברית, שיח ומדינה בהגות הרב זקס" },
        { "label": "הפילוסופיה של הדיאלוג: בין רוזנצווייג לרב זקס" },
        { "label": "מסורת בעידן לא מסורתי" },
        { "label": "מה נלמד?", "children": [
          { "label": "דיאלוג בין אמונה לחברה – נבחן עקרון יסוד בהגות הרב זקס: דיאלוג בין אמונה דתית לבין חברה פלורליסטית-מודרנית כמסגרת הכרחית לעיצוב חיים מוסריים וחברתיים משותפים" },
          { "label": "שמירת המסורת בעידן מודרני – נעמיק באתגר שמציבה המודרניות למסורת הדתית, והאופן בו הרב זקס מציע מודל למסורת רלוונטית, מחייבת ויצירתית גם בתקופה המאופיינת בחילון ובשינוי מתמיד" },
          { "label": "תורה וחכמה – נבחן את עקרון ההפריה ההדדית שבין התורה כקול ייחודי של זהות יהודית פרטיקולרית לבין החכמה האוניברסלית" },
          { "label": "היסודות הפילוסופיים בהגותו – נעמוד על השפעת פרנץ רוזנצווייג ותרומתו של עקרון הדיאלוג וחיי המפגש לעיצוב ההגות של הרב זקס, ונבחן את הממד הביקורתי כלפי הנאורות כבסיס לחשיבה יהודית מחודשת בעידן המודרני" }
        ]}
      ]},
      { "label": "5 - מודרניות וחברה", "children": [
        { "label": "#05 בין מסורת למודרנה" },
        { "label": "בלשון עתיד" },
        { "label": "תפקיד הרב הראשי: מנהיגות יהודית בחברה רב־תרבותית" },
        { "label": "הרב לורד דוד וולפסון: יהדות, השפעה ומנהיגות בזירה האנגלית" },
        { "label": "חלומות ומציאות" },
        { "label": "מדע ודת - ניגוד או השלמה?" },
        { "label": "פרופ׳ אריה צבן - מה בין מדע, אמונה וקיימות?" },
        { "label": "מה נלמד?", "children": [
          { "label": "הבנה מעמיקה של יישומי הגות הרב זקס בתחומי המדע, החברה והמנהיגות, תוך זיהוי הקשרים הרעיוניים בין התחומים השונים" },
          { "label": "היכרות עם ההשפעה המעשית והיישומית של רעיונותיו על מבנים חברתיים, מוסדות ציבוריים ותהליכי קבלת החלטות במגזרים שונים" },
          { "label": "כישורי ניתוח וחשיבה ביקורתית של הקשרים המורכבים בין תיאוריה למעשה בהגות הרב זקס, תוך הבחנה בין עקרונות תיאורטיים ליישומיהם המעשיים" },
          { "label": "הבנה היסטורית ועכשווית: תרומת הרב זקס לשיח העכשווי בנושאי המדע, הדת והחברה, והערכת מקומו בהקשר האינטלקטואלי הרחב יותר" }
        ]}
      ]},
      { "label": "6 - מורשת חיה", "children": [
        { "label": "#06 הגותו של הרב זקס - בין זיכרון ציבורי להשראה" },
        { "label": "פרופ׳ אדם פרזיגר - כיצד הפך הרב זקס לתופעה תרבותית בישראל?" },
        { "label": "הרב דניאל אפשטיין - מציטוטים על הקיר למדף הספרים" },
        { "label": "ד\"ר חיים נריה - הארכיון כבסיס להבנת מורשת הרב זקס" },
        { "label": "ג׳ואנה בנהרוש - אתגרי המודרניות, האחריות הציבורית והזהות היהודית במציאות משתנה" },
        { "label": "ג׳ואן גרינאוויי - מורשת חינוכית כיסוד למנהיגות יהודית מתחדשת" },
        { "label": "החזון החינוכי עפ״י הרב זקס" },
        { "label": "רדיקלית אז רדיקלית עכשיו" },
        { "label": "לצפייה נוספת: דברי הרב מירוויס" },
        { "label": "מה מגדיר את מורשתו המתמשכת של הרב זקס?" },
        { "label": "מה נלמד?", "children": [
          { "label": "בחינת תהליך הפיכתו של הרב זקס לדמות תרבותית בעלת השפעה בשיח הציבורי בישראל" },
          { "label": "ניתוח חדירת רעיונותיו מן ההקשר היומיומי אל השדה ההגותי והספרותי" },
          { "label": "חקירת תרומתו של הארכיון כמרחב לשימור, המשכיות והנחלת המורשת" },
          { "label": "דיון בהשלכות מורשתו על עיצוב חינוך, זהות ומנהיגות יהודית בעידן מודרני" },
          { "label": "עיון במאמר “רדיקלית אז, רדיקלית עכשיו” כהמשגה של המסורת ככוח מתמיד להתחדשות רעיונית וחברתית" }
        ]}
      ]},
      { "label": "7 - סיכום מסע", "children": [
        { "label": "#07 חלון לעתיד: מסורת והתחדשות בהגות יהודית" }
      ]}
    ]
  }
}
</script>

<script>
(function(){
  /* ---------- Parse ---------- */
  let data;
  try{ data = JSON.parse(document.getElementById('mindmap-data').textContent); }
  catch(e){ console.error('Mindmap JSON parse error:', e); data = {"dir":"rtl","flow":"rtl","root":{"label":"שגיאת נתונים - נא לבדוק JSON","children":[]}}; }

  const DIR  = (data.dir||'rtl'); document.documentElement.setAttribute('dir', DIR);
  const FLOW = (data.flow||'rtl');

  const viewport  = document.getElementById('viewport');
  const scroller  = document.getElementById('scroller');
  const stage     = document.getElementById('app');
  const chipLayer = document.getElementById('chips');
  const edgeLayer = document.getElementById('edges');

  /* ---------- Zoom state ---------- */
  let mode = 'fit';                 // 'fit' = הכול במסך ללא גלילה, 'free' = זום חופשי
  let scale = 1;
  const SCALE_MIN_FREE = 0.05;
  const SCALE_MAX      = 3.0;
  const ZOOM_STEP      = 1.10;

  /* ---------- CSS ---------- */
  const CSS = getComputedStyle(document.documentElement);
  const CHIP_H   = +CSS.getPropertyValue('--chip-h').replace('px','') || 48;
  const GAP_X    = +CSS.getPropertyValue('--gap-x').replace('px','') || 36;
  const GAP_X_D01= +CSS.getPropertyValue('--gap-x-d01').replace('px','') || GAP_X;
  const GAP_ROOTCAT = +CSS.getPropertyValue('--gap-rootcat').replace('px','') || 22;
  const GAP_CAT  = +CSS.getPropertyValue('--gap-cat').replace('px','')  || 22;
  const GAP_D3   = +CSS.getPropertyValue('--gap-d3').replace('px','')   || 22;
  const GAP_D4   = +CSS.getPropertyValue('--gap-d4').replace('px','')   || 22;
  const GAP_ITEM = +CSS.getPropertyValue('--gap-item').replace('px','') || 6;
  const GAP_GROUPS = +CSS.getPropertyValue('--gap-between-groups').replace('px','') || 40;

  const PAD_TOP    = +CSS.getPropertyValue('--map-pad-top').replace('px','')    || 0;
  const PAD_BOTTOM = +CSS.getPropertyValue('--map-pad-bottom').replace('px','') || 0;
  const FIT_MARGIN = +CSS.getPropertyValue('--fit-margin').replace('px','')     || 24;
  const ROOT_GUTTER= +CSS.getPropertyValue('--root-gutter').replace('px','')    || 20;

  const DEPTH_COLORS = {0:'#F8E8FF', 1:'#EBDCF8', 2:'#D4D2E6', 3:'#D7F6E4', 4:'#50E38A'};

  /* ---------- Build tree ---------- */
  function build(raw, depth=0, parent=null, idx=0){
    const node = {
      label: raw.label, depth, parent, idx,
      collapsed: (typeof raw.collapsed==='boolean') ? raw.collapsed : (depth!==0),
      x:0,y:0,width:0,height:CHIP_H, el:null, id: Math.random().toString(36).slice(2),
      _subH:0, children: [], gapOverride: (typeof raw.gap==='number'? raw.gap : null)
    };
    (raw.children||[]).forEach((ch,i)=> node.children.push(build(ch, depth+1, node, i)));
    return node;
  }
  const root = build(data.root, 0, null);

  /* ---------- DOM chips ---------- */
  function ensureChip(node){
    if(node.el) return;
    const el = document.createElement('div'); el.className='chip';
    el.dataset.kind = node.depth===0 ? 'root' : (node.children.length? 'cat':'leaf');
    const label = document.createElement('span'); label.className='label'; label.textContent=node.label; el.appendChild(label);
    if(node.children.length){
      const t = document.createElement('button');
      t.className='toggle'; t.type='button'; t.setAttribute('aria-label','פתח/סגור');
      t.innerHTML = '<i class="bar h"></i><i class="bar v"></i>';
      el.appendChild(t);
      el.setAttribute('aria-expanded', String(!node.collapsed));
      t.addEventListener('click', ev=>{ ev.stopPropagation(); handleToggle(node); });
      el.addEventListener('click', ev=>{ if (ev.target.closest('.toggle')) return; handleToggle(node); });
      el.setAttribute('tabindex','0'); el.setAttribute('role','button');
      el.addEventListener('keydown', ev=>{ if(ev.key==='Enter'||ev.key===' '){ ev.preventDefault(); handleToggle(node);} });
    }
    const base = DEPTH_COLORS[Math.min(node.depth,4)] || DEPTH_COLORS[4];
    el.style.setProperty('--chip-bg', base);
    chipLayer.appendChild(el); node.el=el;
  }
  (function collect(n){ ensureChip(n); n.children.forEach(collect); })(root);

  /* ---------- Metrics ---------- */
  function measure(node){
    node.el.style.left = '-10000px';
    node.el.style.top  = '-10000px';
    const w = Math.max(0, node.el.offsetWidth);
    node.width = node.naturalWidth = w;
    node.children.forEach(measure);
  }
  function gapForDepth(d){
    if(d>=4) return GAP_D4;
    if(d===3) return GAP_D3;
    if(d===2) return GAP_CAT;
    if(d===1) return GAP_ROOTCAT;
    return GAP_CAT;
  }
  function subHeight(node){
    if(node.collapsed || node.children.length===0){ node._subH = node.height; return node._subH; }
    let total = 0;
    node.children.forEach((c,i)=>{
      subHeight(c);
      total += c._subH;
      if(i>0){ total += (node.gapOverride != null) ? node.gapOverride : gapForDepth(c.depth); }
      if(node.depth===0 && i<node.children.length-1){ total += GAP_GROUPS; }
    });
    node._subH = Math.max(node.height, total); return node._subH;
  }
  let DEPTH_ANCHORS = new Map();
  function xForDepth(depth){ return DEPTH_ANCHORS.get(depth) || 0; }
  function position(node, depth, top){
    node.x = xForDepth(depth);
    node.y = top + node._subH/2;
    if(!(node.collapsed) && node.children.length){
      let cursor = top;
      node.children.forEach((c,i)=>{
        position(c, depth+1, cursor);
        cursor += c._subH + gapForDepth(c.depth);
        if(node.depth===0 && i<node.children.length-1){ cursor += GAP_GROUPS; }
      });
    }
  }
  function collectVisible(n, arr){ arr.push(n); if(!n.collapsed) n.children.forEach(ch=>collectVisible(ch, arr)); }
  function bounds(nodes){
    let minX=Infinity,maxX=-Infinity,minY=Infinity,maxY=-Infinity;
    nodes.forEach(n=>{
      const left  = (FLOW==='rtl' ? n.x - n.width : n.x);
      const right = (FLOW==='rtl' ? n.x : n.x + n.width);
      minX = Math.min(minX, left);
      maxX = Math.max(maxX, right);
      minY = Math.min(minY, n.y - n.height/2);
      maxY = Math.max(maxY, n.y + n.height/2);
    });
    return { w:(maxX-minX), h:(maxY-minY), minX, maxX, minY, maxY };
  }

  /* ---------- Layout ---------- */
  let contentH = 0, contentW = 0, offsetX = 0, stageW = 0;

  function layout(){
    measure(root);
    subHeight(root); position(root,0,0);

    let vis=[]; collectVisible(root, vis);

    /* רוחב מקס' לעמודות */
    const depthMaxW = new Map();
    vis.forEach(n=>{ depthMaxW.set(n.depth, Math.max(depthMaxW.get(n.depth)||0, n.width||140)); });
    DEPTH_ANCHORS = new Map(); DEPTH_ANCHORS.set(0, 0);
    let acc=0; const maxDepthVis = vis.reduce((m,n)=>Math.max(m,n.depth),0);
    for(let d=1; d<=maxDepthVis+1; d++){
      const addGap = (d===1 ? GAP_X_D01 : GAP_X);
      acc += (depthMaxW.get(d-1)||140) + addGap;
      DEPTH_ANCHORS.set(d, (FLOW==='rtl' ? -acc : acc));
    }

    /* מיקום סופי + גבולות */
    subHeight(root); position(root, 0, 0);
    vis=[]; collectVisible(root, vis);
    const { w, h, minX } = bounds(vis);
    contentW = w; contentH = h;

    /* התאמה למסך */
    const vpW = viewport.clientWidth;
    const vpH = viewport.clientHeight || window.innerHeight;

    const innerW = Math.max(1, vpW - 2*FIT_MARGIN);          /* ב-FIT – סימטרי */
    const innerH = Math.max(1, vpH - PAD_TOP - PAD_BOTTOM);
    const sFitW = innerW / Math.max(1, w);
    const sFitH = innerH / Math.max(1, h);
    const sFit  = Math.min(sFitW, sFitH);

    if (mode === 'fit') { scale = Math.min(1, sFit); }

    /* אופסט צדדי ביחידות-מפה */
    const unit = Math.max(scale, 0.0001);
    if (mode === 'fit'){
      const padL = FIT_MARGIN / unit;
      const padR = FIT_MARGIN / unit;          /* סימטרי ב-FIT – כדי לא "למשוך" לימין */
      offsetX = -minX + padL;
      stageW  = w + padL + padR;
    } else {
      const desiredPad = Math.max(60, Math.floor((vpW/scale - w)/2) + 40);
      offsetX = -minX + desiredPad;
      stageW  = w + desiredPad*2;
    }

    stage.style.width  = Math.ceil(stageW) + 'px';
    stage.style.height = Math.ceil(h) + 'px';

    /* מיקום קפסולות */
    vis.forEach(n=>{
      const top = n.y - n.height/2;
      const rightUnits = offsetX + n.x;
      const leftUnits  = (FLOW==='rtl') ? (rightUnits - n.width) : rightUnits;
      n.el.style.left  = leftUnits  + 'px';
      n.el.style.top   = top + 'px';
      if(n.children.length){ n.el.setAttribute('aria-expanded', String(!n.collapsed)); }
    });

    /* קווים */
    edgeLayer.textContent='';
    (function draw(n){ if(n.collapsed) return; n.children.forEach(ch=>{
      const PAD_PARENT=6, PAD_CHILD=0;
      const parentRight = offsetX + n.x;
      const childRight  = offsetX + ch.x;
      const parentLeft  = parentRight - n.width;
      const p1x = (FLOW==='rtl') ? (parentLeft + PAD_PARENT) : (parentRight - PAD_PARENT);
      const p2x = (FLOW==='rtl') ? (childRight - PAD_CHILD)  : (childRight + ch.width + PAD_CHILD);
      const p1y = n.y, p2y = ch.y;
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      const dx=Math.abs(p2x-p1x)*.45, c1x=(FLOW==='rtl'? p1x-dx: p1x+dx), c2x=(FLOW==='rtl'? p2x+dx: p2x-dx);
      path.setAttribute('class','edge');
      path.setAttribute('d', `M ${p1x} ${p1y} C ${c1x} ${p1y}, ${c2x} ${p2y}, ${p2x} ${p2y}`);
      edgeLayer.appendChild(path);
      draw(ch);
    }); })(root);

    applyZoom();               // מרנדר זום + מרכז
    stage.style.opacity='1';
  }

  /* ---------- Zoom & scroll (מרכוז אמיתי) ---------- */
  let lastScaledW = 0, lastScaledH = 0;

  function centerViewportOnContent(scaledW, scaledH, padLeft, padRight, padTop, padBottom){
    const vpW = viewport.clientWidth, vpH = viewport.clientHeight;

    /* scroller – תמיד מספיק גדול כדי להכיל הכל, שומר מרכוז */
    const paddedContentW = padLeft + scaledW + padRight;
    const paddedContentH = padTop  + scaledH + padBottom;

    const scW = Math.max(vpW, Math.ceil(paddedContentW));
    const scH = Math.max(vpH, Math.ceil(paddedContentH));

    scroller.style.padding = `${padTop}px ${padRight}px ${padBottom}px ${padLeft}px`;
    scroller.style.width   = scW + 'px';
    scroller.style.height  = scH + 'px';

    const flexLeft  = Math.max(0, (scW - paddedContentW)/2);
    const flexTop   = Math.max(0, (scH - paddedContentH)/2);

    /* שמירת מרכז יחסי קודמים (אם יש) */
    let cxRatio = 0.5, cyRatio = 0.5;
    if(lastScaledW>0 && lastScaledH>0){
      const oldScW = Math.max(vpW, lastScaledW + parseFloat(scroller.style.paddingLeft||0) + parseFloat(scroller.style.paddingRight||0));
      const oldFlexLeft = Math.max(0, (oldScW - (lastScaledW + parseFloat(scroller.style.paddingLeft||0) + parseFloat(scroller.style.paddingRight||0)))/2);
      const centerX = viewport.scrollLeft + vpW/2;
      const centerY = viewport.scrollTop  + vpH/2;
      cxRatio = (centerX - oldFlexLeft - parseFloat(scroller.style.paddingLeft||0)) / Math.max(1,lastScaledW);
      cyRatio = (centerY - 0 - parseFloat(scroller.style.paddingTop||0))    / Math.max(1,lastScaledH);
      cxRatio = Math.min(Math.max(cxRatio, 0), 1);
      cyRatio = Math.min(Math.max(cyRatio, 0), 1);
    }

    const wantLeft = Math.round(flexLeft + padLeft + scaledW*cxRatio - vpW/2);
    const wantTop  = Math.round(flexTop  + padTop  + scaledH*cyRatio - vpH/2);

    const maxLeft = Math.max(0, scW - vpW);
    const maxTop  = Math.max(0, scH - vpH);

    viewport.style.overflowX = (maxLeft>0 && mode==='free') ? 'auto' : 'hidden';
    viewport.style.overflowY = (maxTop >0 && mode==='free') ? 'auto' : 'hidden';

    viewport.scrollLeft = Math.min(Math.max(0, wantLeft), maxLeft);
    viewport.scrollTop  = Math.min(Math.max(0, wantTop ), maxTop );

    lastScaledW = scaledW; lastScaledH = scaledH;
  }

  function applyZoom(){
    const pct = document.getElementById('zoomPct');
    if(pct) pct.textContent = Math.round(scale*100) + "%";
    stage.style.transform = `scale(${scale})`;

    const scaledW = Math.ceil(stageW * scale);
    const scaledH = Math.ceil(contentH * scale);

    /* פדינג בפועל */
    let padLeft, padRight, padTop, padBottom;
    if(mode==='fit'){
      /* FIT – סימטרי לחלוטין כדי שלא "יידבק" לימין */
      padLeft  = FIT_MARGIN;
      padRight = FIT_MARGIN;
      padTop   = PAD_TOP;
      padBottom= PAD_BOTTOM;
    } else {
      /* FREE – שוליים סימטריים גדולים + מבטיחים מרווח ימני מינימלי */
      const vpW = viewport.clientWidth, vpH = viewport.clientHeight;
      const side = Math.max(40, Math.floor((vpW - scaledW)/2));
      padLeft  = Math.max(20, side);
      padRight = Math.max(20 + ROOT_GUTTER, side);  /* שומר ≥20px לימין */
      padTop   = Math.max(24, Math.floor((vpH - scaledH)/2));
      padBottom= 32;
    }

    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      centerViewportOnContent(scaledW, scaledH, padLeft, padRight, padTop, padBottom);
    }));
  }

  function fitNow(){ mode='fit'; layout(); }
  function clampFree(v){ return Math.max(SCALE_MIN_FREE, Math.min(SCALE_MAX, v)); }
  function zoomStep(mult){
    mode='free';
    scale = clampFree(scale * mult);
    applyZoom();
  }

  /* ---------- Toggle ---------- */
  function collapseDeep(n){ n.collapsed = true; n.children.forEach(c=>collapseDeep(c)); }
  function animateClose(node, done){
    const list=[]; function collectDesc(n){ if(!n || n.collapsed) return; list.push(n); n.children.forEach(collectDesc); }
    node.children.forEach(collectDesc);
    const dur = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--anim-dur'))*1000+20;
    list.forEach(n=>{
      if(n.el){ n.el.classList.add('fade-exit'); requestAnimationFrame(()=> n.el.classList.add('fade-active')); setTimeout(()=> n.el.classList.remove('fade-exit','fade-active'), dur); }
    });
    setTimeout(done, dur);
  }
  function handleToggle(n){
    if(!n.children.length) return;
    n.collapsed ? (n.collapsed=false, n.el.setAttribute('aria-expanded','true'), layout())
                : (n.el.setAttribute('aria-expanded','false'), animateClose(n, ()=>{ collapseDeep(n); layout(); }));
  }

  /* ---------- Drag-to-pan ---------- */
  let isDown=false, isPanning=false, moved=0, startX=0, startY=0, startSL=0, startST=0, pid=null, wasFitAtDown=false;
  const START_PX = 6;

  function onDown(e){
    if(e.button!==0) return;
    isDown=true; isPanning=false; moved=0; pid=e.pointerId;
    wasFitAtDown = (mode==='fit');            /* מאפשר “שבירת FIT” בגרירה */
    startX=e.clientX; startY=e.clientY; startSL=viewport.scrollLeft; startST=viewport.scrollTop;
  }
  function onMove(e){
    if(!isDown || e.pointerId!==pid) return;
    const dx=e.clientX-startX, dy=e.clientY-startY;
    moved = Math.max(moved, Math.hypot(dx,dy));

    /* אם מתחילים לגרור כשהיינו ב-FIT – עוברים אוטומטית ל-FREE באותו זום */
    if(wasFitAtDown && moved>=START_PX && mode==='fit'){
      mode='free';
      applyZoom();                             /* מחשב פדינגים/גלילה ל-FREE */
      /* מאפס נקודת התחלה לגרירה חלקה */
      startX=e.clientX; startY=e.clientY; startSL=viewport.scrollLeft; startST=viewport.scrollTop;
    }

    if(mode!=='free') return;                  /* ב-FIT אין גרירה עד "שבירה" */
    if(!isPanning && moved>=START_PX){
      isPanning=true; viewport.classList.add('panning'); viewport.setPointerCapture?.(pid);
    }
    if(isPanning){ e.preventDefault(); viewport.scrollLeft=startSL-dx; viewport.scrollTop=startST-dy; }
  }
  function onUp(e){
    if(e.pointerId!==pid) return;
    if(isPanning){ viewport.classList.remove('panning'); try{ viewport.releasePointerCapture?.(pid);}catch(_){ } }
    isDown=false; isPanning=false; pid=null; moved=0; wasFitAtDown=false;
  }
  viewport.addEventListener('pointerdown', onDown, {passive:true});
  viewport.addEventListener('pointermove', onMove, {passive:false});
  viewport.addEventListener('pointerup', onUp, {passive:true});
  viewport.addEventListener('pointercancel', onUp, {passive:true});
  viewport.addEventListener('pointerleave', (e)=>{ if(isDown) onUp(e); }, {passive:true});

  /* גלילת עכבר אופקית/אנכית (FREE) */
  viewport.addEventListener('wheel', (e)=>{
    if (mode!=='free') return;
    if (e.shiftKey || Math.abs(e.deltaX) > Math.abs(e.deltaY)){
      e.preventDefault(); viewport.scrollLeft += (e.deltaX || e.deltaY);
    }
  }, { passive:false });

  /* ---------- Controls ---------- */
  document.getElementById('fitBtn').addEventListener('click', fitNow);
  document.getElementById('zoomIn').addEventListener('click', ()=> zoomStep(ZOOM_STEP));
  document.getElementById('zoomOut').addEventListener('click', ()=> zoomStep(1/ZOOM_STEP));
  document.getElementById('zoomPct').addEventListener('click', ()=>{ mode='free'; scale=1; applyZoom(); });

  document.getElementById('expandAll').addEventListener('click', ()=>{
    (function open(n){ n.collapsed=false; n.children.forEach(open); })(root);
    fitNow();
  });
  document.getElementById('collapseAll').addEventListener('click', ()=>{
    (function close(n){ if(n!==root) n.collapsed=true; n.children.forEach(close); })(root);
    fitNow();
  });

  /* ---------- Size & init ---------- */
  function sizeViewport(){
    const rect = viewport.getBoundingClientRect();
    const avail = window.innerHeight - rect.top - 16;
    viewport.style.height = Math.max(360, Math.floor(avail)) + 'px';
  }
  sizeViewport();
  layout();

  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(()=>{ layout(); });
    document.fonts.addEventListener?.('loadingdone', ()=> { layout(); });
  }
  window.addEventListener('resize', ()=>{ sizeViewport(); layout(); });
})();
</script>
</body>
</html>
